#!/usr/bin/env python3
"""
Cron Agent - Unified command-line interface.

Commands:
    ./cronagent setup       Run first-time setup
    ./cronagent install     Install scheduler
    ./cronagent status      Check scheduler status
    ./cronagent uninstall   Remove scheduler
    ./cronagent             Run agent manually
"""

import sys
import os
from pathlib import Path

# Get paths
root_dir = Path(__file__).parent
src_dir = root_dir / "src"
venv_python = src_dir / "venv" / "bin" / "python3"
env_file = root_dir / ".env"

# Check if running setup command
if len(sys.argv) > 1 and sys.argv[1] == "setup":
    # Run setup using system Python
    sys.path.insert(0, str(src_dir))
    import setup
    setup.main()
    sys.exit(0)

# For all other commands, check if setup was run
if not venv_python.exists():
    print("❌ Virtual environment not found!")
    print()
    print("Please run setup first:")
    print("  ./cronagent setup")
    print()
    sys.exit(1)

# Validate .env configuration
def validate_env():
    """Validate that .env exists and has required configuration."""
    
    # Check if .env exists
    if not env_file.exists():
        print("❌ Configuration file not found!")
        print()
        print("The .env file is missing. Please run setup:")
        print("  ./cronagent setup")
        print()
        return False
    
    # Load .env and check required fields
    required_fields = {
        'TODOIST_TOKEN': 'Todoist API token'
    }
    
    missing_fields = []
    empty_fields = []
    
    # Read .env file
    env_vars = {}
    with open(env_file, 'r') as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith('#') and '=' in line:
                key, value = line.split('=', 1)
                env_vars[key.strip()] = value.strip()
    
    # Check each required field
    for field, description in required_fields.items():
        if field not in env_vars:
            missing_fields.append((field, description))
        elif not env_vars[field] or env_vars[field] in ['your_token_here', 'your-token-here']:
            empty_fields.append((field, description))
    
    # Report errors if any
    if missing_fields or empty_fields:
        print("❌ Configuration validation failed!")
        print()
        
        if missing_fields:
            print("Missing required fields in .env:")
            for field, description in missing_fields:
                print(f"  • {field} - {description}")
            print()
        
        if empty_fields:
            print("Empty or placeholder values in .env:")
            for field, description in empty_fields:
                print(f"  • {field} - {description}")
            print()
        
        print("Please update your .env file:")
        print("  1. Open .env in a text editor")
        print("  2. Add your Todoist API token")
        print("  3. Get token from: https://todoist.com/app/settings/integrations/developer")
        print()
        print("Or run setup again to reconfigure:")
        print("  ./cronagent setup")
        print()
        return False
    
    return True

# Validate configuration before running (except for status command)
if len(sys.argv) == 1 or (len(sys.argv) > 1 and sys.argv[1] not in ['status']):
    if not validate_env():
        sys.exit(1)

# Translate subcommands to flags for compatibility with cron_agent.py
args = sys.argv[1:]
if len(args) > 0:
    if args[0] == "install":
        args[0] = "--install"
    elif args[0] == "uninstall":
        args[0] = "--uninstall"
    elif args[0] == "status":
        args[0] = "--status"

# Use venv Python for all other commands
import subprocess
result = subprocess.run(
    [str(venv_python), str(src_dir / "cron_agent.py")] + args,
    cwd=root_dir
)
sys.exit(result.returncode)
